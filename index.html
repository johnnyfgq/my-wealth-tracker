<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人理财驾驶舱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #121212;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        
        /* 毛玻璃效果 */
        .glass-card {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        /* 渐变文字 */
        .gradient-text {
            background: linear-gradient(135deg, #D4AF37 0%, #50C878 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* 进度条动画 */
        .progress-bar {
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 数字滚动效果 */
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .count-up {
            animation: countUp 0.6s ease-out;
        }
        
        /* 滑动条样式 */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: linear-gradient(to right, #D4AF37 0%, #50C878 100%);
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        
        input[type="range"]:hover {
            opacity: 1;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37 0%, #50C878 100%);
            cursor: pointer;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            transition: all 0.3s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37 0%, #50C878 100%);
            cursor: pointer;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            border: none;
        }
        
        /* 脉动效果 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* 旋转动画（刷新按钮） */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spin-animation {
            animation: spin 1s linear infinite;
        }
        
        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 400px;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Modal 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }
        
        /* 输入框样式 */
        input[type="number"], input[type="text"] {
            background: rgba(50, 50, 50, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 16px;
            color: #e0e0e0;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
        }
        
        input[type="number"]:focus, input[type="text"]:focus {
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        /* 按钮样式 */
        .btn-primary {
            background: linear-gradient(135deg, #D4AF37 0%, #50C878 100%);
            color: #121212;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
        }
        
        .btn-secondary {
            background: rgba(100, 100, 100, 0.5);
            color: #e0e0e0;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: rgba(100, 100, 100, 0.7);
        }
        
        /* 通知提示样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #50C878 0%, #D4AF37 100%);
            color: #121212;
            padding: 16px 24px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(80, 200, 120, 0.4);
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* 按钮组 */
        .button-group {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        /* 编辑按钮 */
        .edit-btn {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #D4AF37;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .edit-btn:hover {
            background: rgba(40, 40, 40, 0.95);
            border-color: rgba(212, 175, 55, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 添加按钮（主要操作） */
        .add-btn {
            background: linear-gradient(135deg, #D4AF37 0%, #50C878 100%);
            color: #121212;
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
        }
    </style>
</head>
<body class="min-h-screen p-6 md:p-10">
    <!-- 按钮组 -->
    <div class="button-group">
        <button class="add-btn" onclick="openAddAssetModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            添加资产
        </button>
        <button class="edit-btn" onclick="openModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            编辑数据
        </button>
    </div>
    
    <!-- 通知提示 -->
    <div id="notification" class="notification">
        ✓ 数据保存成功
    </div>
    
    <!-- Modal 弹窗 -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold gradient-text">编辑资产数据</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="dataForm" onsubmit="saveData(event)" class="space-y-5">
                <!-- 流动资产 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                            流动资产 (现金、存款、货币基金)
                        </span>
                    </label>
                    <input type="number" id="inputLiquidAssets" step="1000" min="0" required>
                </div>
                
                <!-- 固定资产 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                            固定资产 (房产、车辆、实物资产)
                        </span>
                    </label>
                    <input type="number" id="inputFixedAssets" step="1000" min="0" required>
                </div>
                
                <!-- 风险资产 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                            风险资产 (股票、基金、数字资产)
                        </span>
                    </label>
                    <input type="number" id="inputRiskAssets" step="1000" min="0" required>
                </div>
                
                <!-- 目标金额 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                            财富自由目标金额
                        </span>
                    </label>
                    <input type="number" id="inputTargetAssets" step="10000" min="0" required>
                </div>
                
                <!-- 预览当前总资产 -->
                <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                    <div class="text-xs text-gray-500 mb-1">当前总资产</div>
                    <div class="text-2xl font-bold gradient-text" id="previewTotal">¥0</div>
                </div>
                
                <!-- 按钮 -->
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">保存数据</button>
                    <button type="button" onclick="closeModal()" class="btn-secondary">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加资产 Modal -->
    <div id="addAssetModalOverlay" class="modal-overlay" onclick="closeAddAssetModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold gradient-text">添加资产交易</h2>
                <button onclick="closeAddAssetModal()" class="text-gray-400 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="addAssetForm" onsubmit="saveTransaction(event)" class="space-y-5">
                <!-- 市场类型 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">市场类型</label>
                    <select id="inputMarket" onchange="onMarketChange()" class="w-full bg-gray-800/80 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-amber-500 focus:outline-none">
                        <option value="国内基金">国内基金</option>
                        <option value="美股">美股</option>
                        <option value="港股">港股</option>
                        <option value="A股">A股</option>
                    </select>
                </div>
                
                <!-- 交易类型 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">交易类型</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center justify-center px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg cursor-pointer hover:border-emerald-500 transition">
                            <input type="radio" name="transactionType" value="买入" checked class="mr-2">
                            <span>买入</span>
                        </label>
                        <label class="flex items-center justify-center px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg cursor-pointer hover:border-red-500 transition">
                            <input type="radio" name="transactionType" value="卖出" class="mr-2">
                            <span>卖出</span>
                        </label>
                    </div>
                </div>
                
                <!-- 代码/Symbol -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span id="symbolLabel">基金代码</span>
                        <span class="text-xs text-gray-600">(例: 001186, AAPL, 0700.HK, 600519)</span>
                    </label>
                    <input type="text" id="inputSymbol" placeholder="请输入代码" required>
                </div>
                
                <!-- 名称（可选） -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        名称
                        <span class="text-xs text-gray-600">(可选，可从 API 自动获取)</span>
                    </label>
                    <input type="text" id="inputName" placeholder="例: 富国文体健康股票">
                </div>
                
                <!-- 日期 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">交易日期</label>
                    <input type="date" id="inputDate" required>
                </div>
                
                <!-- 价格 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span id="priceLabel">买入价格/净值</span>
                    </label>
                    <input type="number" id="inputPrice" step="0.0001" min="0" placeholder="例: 1.5200" required>
                </div>
                
                <!-- 数量 -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">
                        <span id="quantityLabel">买入份额/股数</span>
                    </label>
                    <input type="number" id="inputQuantity" step="0.01" min="0" placeholder="例: 10000" required>
                </div>
                
                <!-- 国内基金专属：净值更新方式 -->
                <div id="fundOptions" class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                    <div class="text-sm text-blue-400 mb-3">国内基金设置</div>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm cursor-pointer">
                            <input type="radio" name="navUpdateMode" value="auto" checked class="mr-2">
                            <span>自动获取最新净值（推荐）</span>
                        </label>
                        <label class="flex items-center text-sm cursor-pointer">
                            <input type="radio" name="navUpdateMode" value="manual" class="mr-2">
                            <span>手动输入净值</span>
                        </label>
                    </div>
                </div>
                
                <!-- 成本预览 -->
                <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                    <div class="text-xs text-gray-500 mb-1">交易成本</div>
                    <div class="text-2xl font-bold gradient-text" id="transactionCostPreview">¥0</div>
                </div>
                
                <!-- 按钮 -->
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">添加交易</button>
                    <button type="button" onclick="closeAddAssetModal()" class="btn-secondary">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 容器 -->
    <div class="max-w-7xl mx-auto">
        
        <!-- Header: 财富自由倒计时 -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center gap-4 mb-4">
                <h1 class="text-5xl md:text-6xl font-bold">
                    <span class="gradient-text">财富自由倒计时</span>
                </h1>
                <button id="refreshBtn" onclick="refreshAllPrices()" class="glass-card rounded-xl px-4 py-2 hover:scale-105 transition-all" title="刷新所有持仓价格">
                    <svg id="refreshIcon" class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
            <div class="mt-6 max-w-2xl mx-auto">
                <div class="flex justify-between text-sm text-gray-400 mb-2">
                    <span>当前: <span class="text-emerald-400 font-semibold" id="currentAmount">¥0</span></span>
                    <span>目标: <span class="text-amber-400 font-semibold" id="targetAmount">¥10,000,000</span></span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="progress-bar h-full rounded-full bg-gradient-to-r from-amber-500 to-emerald-500" style="width: 0%"></div>
                </div>
                <div class="mt-3 text-3xl font-bold">
                    <span class="gradient-text" id="progressPercent">0%</span>
                </div>
            </div>
        </div>
        
        <!-- 资产概览 -->
        <div class="mb-10">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-300">资产明细</h2>
                <div class="text-sm text-gray-500">持仓实时计算</div>
            </div>
            
            <!-- 手动资产卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- 流动资产 -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-gray-400 text-sm font-medium">流动资产</h3>
                        <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-emerald-400 mb-2" id="liquidAssets">¥0</div>
                    <div class="text-xs text-gray-500">现金 + 存款</div>
                </div>
                
                <!-- 固定资产 -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-gray-400 text-sm font-medium">固定资产</h3>
                        <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-blue-400 mb-2" id="fixedAssets">¥0</div>
                    <div class="text-xs text-gray-500">房产 + 车辆</div>
                </div>
            </div>
            
            <!-- 持仓明细 -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-300">持仓明细</h3>
                    <div class="text-sm">
                        <span class="text-gray-500">总市值: </span>
                        <span class="text-amber-400 font-bold" id="totalHoldingsValue">¥0</span>
                    </div>
                </div>
                
                <!-- 持仓列表 -->
                <div id="holdingsList" class="space-y-3">
                    <!-- 动态渲染持仓项 -->
                    <div class="text-center text-gray-500 py-8">
                        暂无持仓，点击「添加资产」开始记录
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图表和控制台 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 折线图 -->
            <div class="lg:col-span-2 chart-container">
                <h3 class="text-xl font-semibold mb-4 text-gray-300">资产增长趋势</h3>
                <canvas id="assetChart"></canvas>
            </div>
            
            <!-- 控制台 -->
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-xl font-semibold mb-6 text-gray-300">投资模拟器</h3>
                
                <div class="mb-8">
                    <label class="block text-sm text-gray-400 mb-3">预期年化收益率</label>
                    <div class="flex items-center justify-center mb-4">
                        <div class="text-4xl font-bold pulse-animation">
                            <span class="gradient-text" id="returnRate">8.0</span>
                            <span class="text-2xl gradient-text">%</span>
                        </div>
                    </div>
                    <input type="range" id="returnRateSlider" min="0" max="20" step="0.5" value="8" class="w-full">
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>0%</span>
                        <span>保守</span>
                        <span>激进</span>
                        <span>20%</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="p-4 bg-gray-800/50 rounded-xl">
                        <div class="text-xs text-gray-500 mb-1">预测 5 年后</div>
                        <div class="text-xl font-bold text-emerald-400" id="fiveYearProjection">¥6,879,689</div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-xl">
                        <div class="text-xs text-gray-500 mb-1">预测 10 年后</div>
                        <div class="text-xl font-bold text-amber-400" id="tenYearProjection">¥10,794,624</div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-xl">
                        <div class="text-xs text-gray-500 mb-1">达成目标需要</div>
                        <div class="text-xl font-bold gradient-text" id="yearsToGoal">8.5 年</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-12 text-gray-600 text-sm">
            <p>数据仅供参考 | 投资有风险，决策需谨慎</p>
        </div>
        
    </div>

    <script>
        // ============= 数据模型定义 =============
        // 新数据模型：交易流水驱动
        let dataEngine = {
            transactions: [],        // 交易流水数组
            holdings: {},            // 持仓明细（计算得出）
            latestPrices: {},        // 最新价格缓存 { symbol: price }
            manualAssets: {          // 手动录入资产
                liquid: 0,           // 流动资产（现金、存款）
                fixed: 0             // 固定资产（房产、车辆）
            },
            targetAssets: 10000000,  // 目标金额
            returnRate: 8.0,         // 年化收益率
            apiKeys: {               // API 密钥配置
                finnhub: ''          // Finnhub API Key（用户可配置）
            }
        };
        
        // 默认数据配置（兼容旧版本）
        const defaultData = {
            liquidAssets: 1500000,   // 流动资产
            fixedAssets: 2800000,    // 固定资产
            riskAssets: 700000,      // 风险资产
            targetAssets: 10000000,  // 目标金额
            returnRate: 8.0          // 默认年化收益率 8%
        };
        
        // 当前配置数据（向后兼容）
        let config = {
            liquidAssets: 0,
            fixedAssets: 0,
            riskAssets: 0,
            targetAssets: 0,
            currentAssets: 0, // 总资产（计算得出）
            returnRate: 8.0
        };
        
        // ============= 数据引擎核心函数 =============
        // 生成唯一 ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // 添加交易记录
        function addTransaction(transaction) {
            const newTransaction = {
                id: generateId(),
                date: transaction.date || new Date().toISOString().split('T')[0],
                symbol: transaction.symbol,
                name: transaction.name || '',
                market: transaction.market, // 'A股'|'港股'|'美股'|'国内基金'
                type: transaction.type,     // '买入'|'卖出'
                price: parseFloat(transaction.price),
                quantity: parseFloat(transaction.quantity)
            };
            
            dataEngine.transactions.push(newTransaction);
            console.log('✓ 添加交易记录:', newTransaction);
            return newTransaction;
        }
        
        // 删除交易记录
        function deleteTransaction(id) {
            const index = dataEngine.transactions.findIndex(t => t.id === id);
            if (index !== -1) {
                dataEngine.transactions.splice(index, 1);
                console.log('✓ 删除交易记录:', id);
                return true;
            }
            return false;
        }
        
        // 持仓计算引擎：根据 transactions 聚合计算持仓
        function calculateHoldings() {
            const holdings = {};
            
            // 按 symbol 分组统计
            dataEngine.transactions.forEach(transaction => {
                const { symbol, market, name, type, price, quantity } = transaction;
                
                if (!holdings[symbol]) {
                    holdings[symbol] = {
                        symbol: symbol,
                        name: name,
                        market: market,
                        quantity: 0,           // 净持仓数量
                        totalCost: 0,          // 总成本
                        avgCost: 0,            // 平均成本
                        latestPrice: 0,        // 最新价格
                        marketValue: 0         // 市值
                    };
                }
                
                if (type === '买入') {
                    holdings[symbol].quantity += quantity;
                    holdings[symbol].totalCost += price * quantity;
                } else if (type === '卖出') {
                    holdings[symbol].quantity -= quantity;
                    holdings[symbol].totalCost -= price * quantity;
                }
            });
            
            // 计算平均成本，过滤已清仓的持仓
            const activeHoldings = {};
            for (const symbol in holdings) {
                const holding = holdings[symbol];
                if (holding.quantity > 0) {
                    holding.avgCost = holding.totalCost / holding.quantity;
                    // 从缓存获取最新价格
                    holding.latestPrice = dataEngine.latestPrices[symbol] || holding.avgCost;
                    holding.marketValue = holding.quantity * holding.latestPrice;
                    activeHoldings[symbol] = holding;
                }
            }
            
            dataEngine.holdings = activeHoldings;
            console.log('✓ 持仓计算完成:', activeHoldings);
            return activeHoldings;
        }
        
        // 计算总资产（新逻辑）
        function calculateTotalAssets() {
            // 先计算持仓
            calculateHoldings();
            
            // 总资产 = Σ(持仓市值) + 手动资产
            let totalHoldingsValue = 0;
            for (const symbol in dataEngine.holdings) {
                totalHoldingsValue += dataEngine.holdings[symbol].marketValue;
            }
            
            const totalAssets = totalHoldingsValue + dataEngine.manualAssets.liquid + dataEngine.manualAssets.fixed;
            
            // 更新到 config（向后兼容）
            config.currentAssets = totalAssets;
            
            console.log('✓ 总资产计算:', {
                持仓市值: totalHoldingsValue,
                流动资产: dataEngine.manualAssets.liquid,
                固定资产: dataEngine.manualAssets.fixed,
                总资产: totalAssets
            });
            
            return totalAssets;
        }
        
        // 更新最新价格
        function updateLatestPrice(symbol, price) {
            dataEngine.latestPrices[symbol] = parseFloat(price);
            console.log(`✓ 更新 ${symbol} 最新价格:`, price);
        }
        
        // ============= API 数据获取模块 =============
        // 国内基金：天天基金 JSONP 获取净值
        let fundRequestQueue = []; // 请求队列
        let isFetchingFund = false; // 是否正在请求
        
        function fetchFundNav(fundCode) {
            return new Promise((resolve, reject) => {
                const timestamp = Date.now();
                const url = `http://fundgz.1234567.com.cn/js/${fundCode}.js?rt=${timestamp}`;
                const timeout = 10000; // 10秒超时
                
                // 创建超时定时器
                const timeoutId = setTimeout(() => {
                    cleanup();
                    reject(new Error(`请求超时: ${fundCode}`));
                }, timeout);
                
                // 创建全局回调函数（使用唯一名称避免冲突）
                const callbackName = `jsonpgz_${fundCode}_${timestamp}`;
                window[callbackName] = function(data) {
                    clearTimeout(timeoutId);
                    cleanup();
                    
                    try {
                        // 提取净值数据
                        const nav = parseFloat(data.gsz) || parseFloat(data.dwjz) || 0; // 优先使用估值，其次单位净值
                        const navData = {
                            fundcode: data.fundcode,
                            name: data.name,
                            nav: nav,                    // 净值
                            navDate: data.jzrq,          // 净值日期
                            estimatedNav: data.gsz,      // 估算净值
                            estimatedChange: data.gszzl, // 估算涨幅
                            updateTime: data.gztime      // 更新时间
                        };
                        
                        console.log(`✓ 获取基金净值成功: ${data.name} (${fundCode}) = ${nav}`);
                        resolve(navData);
                    } catch (error) {
                        reject(new Error(`解析基金数据失败: ${error.message}`));
                    }
                };
                
                // 创建 script 标签
                const script = document.createElement('script');
                script.src = url.replace('jsonpgz', callbackName); // 替换回调函数名
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    cleanup();
                    reject(new Error(`网络请求失败: ${fundCode}`));
                };
                
                // 清理函数
                function cleanup() {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                }
                
                // 由于天天基金 API 固定使用 jsonpgz 回调，我们需要用原始方式
                // 重新实现：使用全局 jsonpgz 回调
                window.jsonpgz = function(data) {
                    clearTimeout(timeoutId);
                    
                    try {
                        const nav = parseFloat(data.gsz) || parseFloat(data.dwjz) || 0;
                        const navData = {
                            fundcode: data.fundcode,
                            name: data.name,
                            nav: nav,
                            navDate: data.jzrq,
                            estimatedNav: data.gsz,
                            estimatedChange: data.gszzl,
                            updateTime: data.gztime
                        };
                        
                        console.log(`✓ 获取基金净值成功: ${data.name} (${fundCode}) = ${nav}`);
                        resolve(navData);
                    } catch (error) {
                        reject(new Error(`解析基金数据失败: ${error.message}`));
                    } finally {
                        cleanup();
                    }
                };
                
                script.src = url;
                document.head.appendChild(script);
            });
        }
        
        // 美股/港股：Finnhub + CORS 代理获取股价
        async function fetchStockPrice(symbol, market) {
            try {
                // 检查是否配置了 API Key
                if (!dataEngine.apiKeys.finnhub) {
                    throw new Error('未配置 Finnhub API Key');
                }
                
                // 根据市场格式化 symbol
                let formattedSymbol = symbol;
                if (market === '港股' && !symbol.includes('.HK')) {
                    formattedSymbol = `${symbol}.HK`;
                }
                
                // Finnhub API endpoint
                const finnhubUrl = `https://finnhub.io/api/v1/quote?symbol=${formattedSymbol}&token=${dataEngine.apiKeys.finnhub}`;
                
                // 使用 CORS 代理
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const proxyUrl = corsProxy + encodeURIComponent(finnhubUrl);
                
                console.log(`⏳ 获取 ${market} 股价: ${formattedSymbol}...`);
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Finnhub 返回格式：{ c: 当前价, h: 最高价, l: 最低价, o: 开盘价, pc: 昨收价, t: 时间戳 }
                const price = data.c || 0;
                
                if (price === 0) {
                    throw new Error('未获取到有效价格');
                }
                
                console.log(`✓ 获取股价成功: ${formattedSymbol} = ${price}`);
                
                return {
                    symbol: formattedSymbol,
                    price: price,
                    open: data.o,
                    high: data.h,
                    low: data.l,
                    previousClose: data.pc,
                    timestamp: data.t
                };
                
            } catch (error) {
                console.error(`❌ 获取股价失败 (${symbol}):`, error.message);
                throw error;
            }
        }
        
        // A股：暂不实现（可后续扩展，使用新浪财经或其他 API）
        async function fetchAStockPrice(symbol) {
            throw new Error('A股数据获取功能暂未实现，请手动输入价格');
        }
        
        // ============= 刷新所有价格 =============
        // 刷新所有持仓的最新价格
        async function refreshAllPrices() {
            const holdings = Object.values(dataEngine.holdings);
            
            if (holdings.length === 0) {
                showNotification('⚠️ 暂无持仓，无需刷新');
                return;
            }
            
            // 开始 loading 动画
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            refreshBtn.disabled = true;
            refreshIcon.classList.add('spin-animation');
            
            console.log(`⏳ 开始刷新 ${holdings.length} 个持仓的价格...`);
            
            let successCount = 0;
            let failCount = 0;
            const errors = [];
            
            // 串行请求（避免并发过多导致被限流）
            for (const holding of holdings) {
                try {
                    let price = null;
                    
                    if (holding.market === '国内基金') {
                        // 国内基金：使用 JSONP
                        const data = await fetchFundNav(holding.symbol);
                        price = data.nav;
                    } else if (holding.market === '美股' || holding.market === '港股') {
                        // 美股/港股：使用 Finnhub + CORS 代理
                        const data = await fetchStockPrice(holding.symbol, holding.market);
                        price = data.price;
                    } else if (holding.market === 'A股') {
                        // A股：暂不支持，抛出错误
                        throw new Error('A股暂不支持自动获取');
                    }
                    
                    if (price && price > 0) {
                        updateLatestPrice(holding.symbol, price);
                        successCount++;
                    } else {
                        throw new Error('未获取到有效价格');
                    }
                    
                } catch (error) {
                    console.error(`❌ 获取 ${holding.symbol} 价格失败:`, error.message);
                    failCount++;
                    errors.push({
                        symbol: holding.symbol,
                        name: holding.name,
                        error: error.message
                    });
                }
                
                // 添加延迟，避免请求过快
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // 结束 loading 动画
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('spin-animation');
            
            // 重新计算总资产
            calculateTotalAssets();
            
            // 保存到 localStorage
            saveDataToStorage();
            
            // 更新界面
            updateAllUI();
            
            // 显示结果通知
            if (failCount === 0) {
                showNotification(`✓ 刷新成功！已更新 ${successCount} 个持仓`);
            } else {
                showNotification(`⚠️ 刷新完成：成功 ${successCount} 个，失败 ${failCount} 个`);
                
                // 如果有失败项，在控制台显示详情
                if (errors.length > 0) {
                    console.warn('刷新失败的持仓:');
                    errors.forEach(err => {
                        console.warn(`  - ${err.name} (${err.symbol}): ${err.error}`);
                    });
                }
            }
            
            console.log(`✓ 刷新完成: 成功 ${successCount}, 失败 ${failCount}`);
        }
        
        // ============= LocalStorage 操作 =============
        // 从 localStorage 加载数据（支持新旧格式）
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('investmentData');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    
                    // 检测数据格式：新格式包含 transactions 字段
                    if (parsed.transactions !== undefined) {
                        // 新格式：交易流水驱动
                        dataEngine.transactions = parsed.transactions || [];
                        dataEngine.latestPrices = parsed.latestPrices || {};
                        dataEngine.manualAssets = parsed.manualAssets || { liquid: 0, fixed: 0 };
                        dataEngine.targetAssets = parsed.targetAssets || defaultData.targetAssets;
                        dataEngine.returnRate = parsed.returnRate || defaultData.returnRate;
                        dataEngine.apiKeys = parsed.apiKeys || { finnhub: '' };
                        
                        console.log('✓ 加载新格式数据 (交易流水驱动)');
                        console.log(`  - 交易记录: ${dataEngine.transactions.length} 条`);
                        console.log(`  - 手动资产: 流动 ¥${dataEngine.manualAssets.liquid.toLocaleString()}, 固定 ¥${dataEngine.manualAssets.fixed.toLocaleString()}`);
                    } else {
                        // 旧格式：静态金额模式，执行数据迁移
                        console.log('⚠️ 检测到旧格式数据，执行迁移...');
                        migrateOldData(parsed);
                    }
                    
                    // 同步到 config（向后兼容）
                    config.targetAssets = dataEngine.targetAssets;
                    config.returnRate = dataEngine.returnRate;
                    
                } catch (error) {
                    console.error('❌ 加载数据失败，使用默认值', error);
                    useDefaultData();
                }
            } else {
                console.log('未找到保存的数据，使用默认值');
                useDefaultData();
            }
            
            // 计算总资产
            calculateTotalAssets();
        }
        
        // 旧数据迁移逻辑
        function migrateOldData(oldData) {
            // 将旧的 liquidAssets 和 fixedAssets 转为 manualAssets
            dataEngine.manualAssets.liquid = oldData.liquidAssets || defaultData.liquidAssets;
            dataEngine.manualAssets.fixed = oldData.fixedAssets || defaultData.fixedAssets;
            
            // 旧的 riskAssets 无法直接迁移到交易流水（需要用户重新录入）
            // 暂时作为提示信息
            if (oldData.riskAssets && oldData.riskAssets > 0) {
                console.log(`⚠️ 检测到风险资产 ¥${oldData.riskAssets.toLocaleString()}，请手动添加交易记录`);
                // 可选：显示提示框告知用户
            }
            
            dataEngine.targetAssets = oldData.targetAssets || defaultData.targetAssets;
            dataEngine.returnRate = oldData.returnRate || defaultData.returnRate;
            dataEngine.transactions = [];
            dataEngine.latestPrices = {};
            
            console.log('✓ 数据迁移完成');
            console.log(`  - 流动资产: ¥${dataEngine.manualAssets.liquid.toLocaleString()}`);
            console.log(`  - 固定资产: ¥${dataEngine.manualAssets.fixed.toLocaleString()}`);
            
            // 自动保存新格式
            saveDataToStorage();
        }
        
        // 使用默认数据
        function useDefaultData() {
            // 新格式
            dataEngine.manualAssets.liquid = defaultData.liquidAssets;
            dataEngine.manualAssets.fixed = defaultData.fixedAssets;
            dataEngine.targetAssets = defaultData.targetAssets;
            dataEngine.returnRate = defaultData.returnRate;
            dataEngine.transactions = [];
            dataEngine.latestPrices = {};
            dataEngine.apiKeys = { finnhub: '' };
            
            // 向后兼容
            config.targetAssets = defaultData.targetAssets;
            config.returnRate = defaultData.returnRate;
        }
        
        // 保存数据到 localStorage（新格式）
        function saveDataToStorage() {
            const dataToSave = {
                transactions: dataEngine.transactions,
                latestPrices: dataEngine.latestPrices,
                manualAssets: dataEngine.manualAssets,
                targetAssets: dataEngine.targetAssets,
                returnRate: dataEngine.returnRate,
                apiKeys: dataEngine.apiKeys,
                lastUpdated: new Date().toISOString(),
                version: '2.0' // 标记数据版本
            };
            
            localStorage.setItem('investmentData', JSON.stringify(dataToSave));
            console.log('✓ 数据已保存到 localStorage (v2.0)');
        }
        
        // ============= Modal 弹窗控制 =============
        // 打开 Modal（编辑手动资产）
        function openModal() {
            // 填充当前数据到表单（使用新的 dataEngine）
            document.getElementById('inputLiquidAssets').value = dataEngine.manualAssets.liquid;
            document.getElementById('inputFixedAssets').value = dataEngine.manualAssets.fixed;
            document.getElementById('inputRiskAssets').value = 0; // 风险资产字段保留但不使用
            document.getElementById('inputTargetAssets').value = dataEngine.targetAssets;
            
            // 更新预览
            updatePreviewTotal();
            
            // 显示 Modal
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭 Modal
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // 点击遮罩层关闭
        function closeModalOnOverlay(event) {
            if (event.target.id === 'modalOverlay') {
                closeModal();
            }
        }
        
        // 按 ESC 键关闭 Modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('modalOverlay');
                const addModal = document.getElementById('addAssetModalOverlay');
                if (modal.classList.contains('active')) {
                    closeModal();
                } else if (addModal.classList.contains('active')) {
                    closeAddAssetModal();
                }
            }
        });
        
        // ============= 添加资产 Modal 控制 =============
        // 打开添加资产 Modal
        function openAddAssetModal() {
            // 重置表单
            document.getElementById('addAssetForm').reset();
            
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputDate').value = today;
            
            // 初始化市场类型
            onMarketChange();
            
            // 显示 Modal
            document.getElementById('addAssetModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭添加资产 Modal
        function closeAddAssetModal() {
            document.getElementById('addAssetModalOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // 点击遮罩层关闭
        function closeAddAssetModalOnOverlay(event) {
            if (event.target.id === 'addAssetModalOverlay') {
                closeAddAssetModal();
            }
        }
        
        // 市场类型改变时的处理
        function onMarketChange() {
            const market = document.getElementById('inputMarket').value;
            const fundOptions = document.getElementById('fundOptions');
            const symbolLabel = document.getElementById('symbolLabel');
            const priceLabel = document.getElementById('priceLabel');
            const quantityLabel = document.getElementById('quantityLabel');
            
            // 根据市场类型更新标签和显示
            if (market === '国内基金') {
                fundOptions.style.display = 'block';
                symbolLabel.textContent = '基金代码';
                priceLabel.textContent = '买入净值';
                quantityLabel.textContent = '买入份额';
            } else {
                fundOptions.style.display = 'none';
                symbolLabel.textContent = '股票代码';
                priceLabel.textContent = '买入价格';
                quantityLabel.textContent = '买入股数';
            }
            
            // 更新成本预览
            updateTransactionCostPreview();
        }
        
        // 实时更新交易成本预览
        function updateTransactionCostPreview() {
            const price = parseFloat(document.getElementById('inputPrice').value) || 0;
            const quantity = parseFloat(document.getElementById('inputQuantity').value) || 0;
            const cost = price * quantity;
            document.getElementById('transactionCostPreview').textContent = formatCurrency(cost);
        }
        
        // 监听价格和数量变化，实时更新预览
        document.addEventListener('DOMContentLoaded', function() {
            const priceInput = document.getElementById('inputPrice');
            const quantityInput = document.getElementById('inputQuantity');
            
            if (priceInput) {
                priceInput.addEventListener('input', updateTransactionCostPreview);
            }
            if (quantityInput) {
                quantityInput.addEventListener('input', updateTransactionCostPreview);
            }
        });
        
        // 保存交易记录
        function saveTransaction(event) {
            event.preventDefault();
            
            // 获取表单数据
            const market = document.getElementById('inputMarket').value;
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const symbol = document.getElementById('inputSymbol').value.trim();
            const name = document.getElementById('inputName').value.trim();
            const date = document.getElementById('inputDate').value;
            const price = parseFloat(document.getElementById('inputPrice').value);
            const quantity = parseFloat(document.getElementById('inputQuantity').value);
            
            // 构建交易对象
            const transaction = {
                market: market,
                type: type,
                symbol: symbol,
                name: name || symbol, // 如果没有名称，使用代码
                date: date,
                price: price,
                quantity: quantity
            };
            
            // 添加到数据引擎
            addTransaction(transaction);
            
            // 如果是国内基金且选择自动获取净值，尝试获取
            if (market === '国内基金') {
                const navMode = document.querySelector('input[name="navUpdateMode"]:checked').value;
                if (navMode === 'auto') {
                    fetchFundNav(symbol)
                        .then(data => {
                            updateLatestPrice(symbol, data.nav);
                            calculateTotalAssets();
                            updateAllUI();
                            console.log(`✓ 自动获取基金净值成功: ${data.name} = ${data.nav}`);
                        })
                        .catch(error => {
                            console.warn(`⚠️ 自动获取净值失败，使用买入价格: ${error.message}`);
                            // 降级：使用买入价格作为当前净值
                            updateLatestPrice(symbol, price);
                        });
                } else {
                    // 手动模式：使用买入价格
                    updateLatestPrice(symbol, price);
                }
            } else {
                // 非基金：使用买入价格作为初始价格
                updateLatestPrice(symbol, price);
            }
            
            // 重新计算并保存
            calculateTotalAssets();
            saveDataToStorage();
            
            // 关闭 Modal
            closeAddAssetModal();
            
            // 显示成功通知
            showNotification('✓ 交易记录已添加');
            
            // 更新界面
            updateAllUI();
        }
        
        // 更新预览总资产
        function updatePreviewTotal() {
            const liquid = parseFloat(document.getElementById('inputLiquidAssets').value) || 0;
            const fixed = parseFloat(document.getElementById('inputFixedAssets').value) || 0;
            const risk = parseFloat(document.getElementById('inputRiskAssets').value) || 0;
            const total = liquid + fixed + risk;
            document.getElementById('previewTotal').textContent = formatCurrency(total);
        }
        
        // 监听输入变化，实时更新预览
        document.addEventListener('DOMContentLoaded', function() {
            ['inputLiquidAssets', 'inputFixedAssets', 'inputRiskAssets'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreviewTotal);
            });
        });
        
        // ============= 保存数据 =============
        // 保存数据（表单提交 - 手动资产）
        function saveData(event) {
            event.preventDefault();
            
            // 获取表单数据
            const newLiquid = parseFloat(document.getElementById('inputLiquidAssets').value);
            const newFixed = parseFloat(document.getElementById('inputFixedAssets').value);
            const newTarget = parseFloat(document.getElementById('inputTargetAssets').value);
            
            // 更新 dataEngine
            dataEngine.manualAssets.liquid = newLiquid;
            dataEngine.manualAssets.fixed = newFixed;
            dataEngine.targetAssets = newTarget;
            
            // 同步到 config（向后兼容）
            config.targetAssets = newTarget;
            
            // 重新计算总资产
            calculateTotalAssets();
            
            // 保存到 localStorage
            saveDataToStorage();
            
            // 关闭 Modal
            closeModal();
            
            // 显示保存成功通知
            showNotification('✓ 数据保存成功');
            
            // 实时更新页面所有数据
            updateAllUI();
        }
        
        // ============= 通知提示 =============
        // 显示保存成功通知
        function showNotification(message = '✓ 数据保存成功') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ============= UI 更新函数 =============
        // 更新所有 UI 元素
        function updateAllUI() {
            // 更新资产卡片
            updateAssetCards();
            
            // 更新持仓列表
            renderHoldingsList();
            
            // 更新进度条
            updateProgress();
            
            // 更新目标金额显示
            document.getElementById('targetAmount').textContent = '¥' + dataEngine.targetAssets.toLocaleString();
            
            // 更新图表
            updateChart();
            
            // 更新预测数据
            updateProjections();
        }
        
        // 更新资产卡片（新逻辑：手动资产）
        function updateAssetCards() {
            const liquidEl = document.getElementById('liquidAssets');
            const fixedEl = document.getElementById('fixedAssets');
            
            // 使用新的 dataEngine.manualAssets
            liquidEl.textContent = formatCurrency(dataEngine.manualAssets.liquid);
            fixedEl.textContent = formatCurrency(dataEngine.manualAssets.fixed);
        }
        
        // 渲染持仓列表
        function renderHoldingsList() {
            const holdingsList = document.getElementById('holdingsList');
            const totalHoldingsValue = document.getElementById('totalHoldingsValue');
            
            const holdings = dataEngine.holdings;
            const holdingsArray = Object.values(holdings);
            
            if (holdingsArray.length === 0) {
                holdingsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无持仓，点击「添加资产」开始记录
                    </div>
                `;
                totalHoldingsValue.textContent = '¥0';
                return;
            }
            
            // 计算总市值
            let totalValue = 0;
            holdingsArray.forEach(h => totalValue += h.marketValue);
            totalHoldingsValue.textContent = formatCurrency(totalValue);
            
            // 渲染持仓项
            holdingsList.innerHTML = holdingsArray.map(holding => {
                const profit = holding.marketValue - holding.totalCost;
                const profitRate = ((profit / holding.totalCost) * 100).toFixed(2);
                const profitColor = profit >= 0 ? 'text-emerald-400' : 'text-red-400';
                const profitSign = profit >= 0 ? '+' : '';
                
                // 市场标签颜色
                const marketColors = {
                    '国内基金': 'bg-blue-500/20 text-blue-400',
                    '美股': 'bg-purple-500/20 text-purple-400',
                    '港股': 'bg-pink-500/20 text-pink-400',
                    'A股': 'bg-red-500/20 text-red-400'
                };
                const marketClass = marketColors[holding.market] || 'bg-gray-500/20 text-gray-400';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-white font-semibold">${holding.name}</span>
                                <span class="text-xs px-2 py-1 rounded ${marketClass}">${holding.market}</span>
                            </div>
                            <div class="text-xs text-gray-500">${holding.symbol}</div>
                        </div>
                        
                        <div class="text-right">
                            <div class="text-sm text-gray-400">
                                持仓: ${holding.quantity.toFixed(2)} | 成本: ¥${holding.avgCost.toFixed(4)}
                            </div>
                            <div class="text-sm text-gray-400">
                                现价: ¥${holding.latestPrice.toFixed(4)} | 市值: <span class="text-white font-semibold">${formatCurrency(holding.marketValue)}</span>
                            </div>
                            <div class="text-sm ${profitColor} font-semibold mt-1">
                                ${profitSign}${formatCurrency(profit)} (${profitSign}${profitRate}%)
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 更新进度条
        function updateProgress() {
            const percent = (config.currentAssets / config.targetAssets * 100).toFixed(1);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('currentAmount').textContent = '¥' + config.currentAssets.toLocaleString();
        }
        
        // 更新图表
        function updateChart() {
            assetChart.data.datasets[0].data = generateChartData(10);
            assetChart.update('active');
        }
        
        // 格式化金额
        function formatCurrency(amount) {
            return '¥' + Math.round(amount).toLocaleString();
        }
        
        // 计算未来价值
        function calculateFutureValue(principal, rate, years) {
            return principal * Math.pow(1 + rate / 100, years);
        }
        
        // 计算达成目标所需年限
        function calculateYearsToGoal(current, target, rate) {
            if (current >= target) return 0;
            return Math.log(target / current) / Math.log(1 + rate / 100);
        }
        
        // 更新预测数据
        function updateProjections() {
            const rate = dataEngine.returnRate;
            const current = config.currentAssets;
            const target = dataEngine.targetAssets;
            
            const fiveYear = calculateFutureValue(current, rate, 5);
            const tenYear = calculateFutureValue(current, rate, 10);
            const yearsNeeded = calculateYearsToGoal(current, target, rate);
            
            document.getElementById('fiveYearProjection').textContent = formatCurrency(fiveYear);
            document.getElementById('tenYearProjection').textContent = formatCurrency(tenYear);
            
            if (yearsNeeded === 0) {
                document.getElementById('yearsToGoal').textContent = '已达成 🎉';
            } else if (yearsNeeded > 50) {
                document.getElementById('yearsToGoal').textContent = '需调整策略';
            } else {
                document.getElementById('yearsToGoal').textContent = yearsNeeded.toFixed(1) + ' 年';
            }
        }
        
        // 生成图表数据
        function generateChartData(years = 10) {
            const data = [];
            const rate = dataEngine.returnRate / 100;
            const current = config.currentAssets;
            
            for (let i = 0; i <= years; i++) {
                const value = current * Math.pow(1 + rate, i);
                data.push(Math.round(value));
            }
            
            return data;
        }
        
        // 初始化图表
        const ctx = document.getElementById('assetChart').getContext('2d');
        const assetChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 11}, (_, i) => i + '年'),
                datasets: [{
                    label: '资产总额',
                    data: generateChartData(10),
                    borderColor: 'rgba(212, 175, 55, 1)',
                    backgroundColor: function(context) {
                        const ctx = context.chart.ctx;
                        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                        gradient.addColorStop(0, 'rgba(212, 175, 55, 0.3)');
                        gradient.addColorStop(1, 'rgba(80, 200, 120, 0.1)');
                        return gradient;
                    },
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: 'rgba(212, 175, 55, 1)',
                    pointBorderColor: '#121212',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(18, 18, 18, 0.9)',
                        titleColor: '#D4AF37',
                        bodyColor: '#e0e0e0',
                        borderColor: 'rgba(212, 175, 55, 0.3)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return '资产: ¥' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)',
                        },
                        ticks: {
                            color: '#888'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)',
                        },
                        ticks: {
                            color: '#888',
                            callback: function(value) {
                                return '¥' + (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });
        
        // ============= 滑动条事件 =============
        const slider = document.getElementById('returnRateSlider');
        const returnRateDisplay = document.getElementById('returnRate');
        
        slider.addEventListener('input', function() {
            dataEngine.returnRate = parseFloat(this.value);
            config.returnRate = dataEngine.returnRate; // 同步到 config（向后兼容）
            returnRateDisplay.textContent = dataEngine.returnRate.toFixed(1);
            
            // 更新图表
            assetChart.data.datasets[0].data = generateChartData(10);
            assetChart.update('active');
            
            // 更新预测
            updateProjections();
            
            // 自动保存年化收益率到 localStorage
            saveDataToStorage();
        });
        
        // ============= 数字动画效果 =============
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                element.textContent = formatCurrency(value);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // ============= 页面初始化 =============
        // 页面加载时执行
        window.addEventListener('load', function() {
            // 第一步：从 localStorage 加载数据
            loadDataFromStorage();
            
            // 第二步：初始化滑动条
            slider.value = dataEngine.returnRate;
            returnRateDisplay.textContent = dataEngine.returnRate.toFixed(1);
            
            // 第三步：初始化 UI
            updateProgress();
            updateProjections();
            updateAllUI();
            
            console.log('✓ 页面初始化完成');
            console.log('交易记录:', dataEngine.transactions.length, '条');
            console.log('持仓数量:', Object.keys(dataEngine.holdings).length, '个');
            console.log('手动资产:', dataEngine.manualAssets);
            console.log('总资产:', formatCurrency(config.currentAssets));
        });
    </script>
</body>
</html>
